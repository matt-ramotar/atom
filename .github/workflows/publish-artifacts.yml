name: Publish Artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: read

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  verify-release:
    if: ${{ github.repository == 'matt-ramotar/atom' }}
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for Gradlew
        run: chmod +x gradlew

      - name: Validate release version is non-snapshot
        run: |
          VERSION=$(grep '^atom = "' gradle/libs.versions.toml | sed 's/.*= "\(.*\)"/\1/')
          if [[ "$VERSION" == *-SNAPSHOT ]]; then
            echo "::error::Refusing release publish for SNAPSHOT version: $VERSION"
            exit 1
          fi
          echo "Validated release version: $VERSION"

      - name: Verify API compatibility gates
        run: ./gradlew apiCheck --no-configuration-cache

      - name: Verify JVM and plugin gates
        run: ./gradlew :ksp:jvmTest :ksp:allTests :gradle-plugin:test :runtime:jvmTest :metro:jvmTest :sample:jvmTest --continue --no-configuration-cache

      - name: Verify Android smoke gates
        run: ./gradlew :runtime:testDebugUnitTest :metro:testDebugUnitTest :sample:testDebugUnitTest :runtime:lintDebug :metro:lintDebug :sample:lintDebug --continue --no-configuration-cache

      - name: Verify JS smoke gates
        env:
          CHROME_BIN: /Applications/Google Chrome.app/Contents/MacOS/Google Chrome
        run: ./gradlew :runtime:jsBrowserTest :runtime:jsTest :metro:jsTest :sample:jsTest --continue --no-configuration-cache

      - name: Verify native test and link smoke gates
        run: ./gradlew :runtime:iosSimulatorArm64Test :metro:iosSimulatorArm64Test :sample:iosSimulatorArm64Test :runtime:linkDebugTestIosX64 :metro:linkDebugTestIosX64 :sample:linkDebugTestIosX64 --continue --no-configuration-cache

  publish:
    if: ${{ github.repository == 'matt-ramotar/atom' }}
    needs: verify-release
    runs-on: macos-latest

    strategy:
      matrix:
        module-config:
          - name: "runtime"
            version_key: "atom"
            version_env: "ATOM_VERSION_NAME"
            path: ":runtime"
          - name: "ksp"
            version_key: "atom"
            version_env: "ATOM_VERSION_NAME"
            path: ":ksp"
          - name: "metro"
            version_key: "atom"
            version_env: "ATOM_VERSION_NAME"
            path: ":metro"
          - name: "gradle-plugin"
            version_key: "atom"
            version_env: "ATOM_VERSION_NAME"
            path: ":gradle-plugin"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for Gradlew
        run: chmod +x gradlew

      - name: Log release version
        run: |
          VERSION=$(grep "^${{ matrix.module-config.version_key }} = " gradle/libs.versions.toml | sed 's/.*= "\(.*\)"/\1/')
          echo "Publishing ${{ matrix.module-config.name }} version: $VERSION"

      - name: Publish artifact to Maven Central
        run: ./gradlew ${{ matrix.module-config.path }}:publishAndReleaseToMavenCentral --no-configuration-cache
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
